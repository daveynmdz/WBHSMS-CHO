<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Change Password</title>
  <link rel="stylesheet" href="css/changePassword.css" />
</head>

<body>
  <header>
    <div class="logo-container">
      <img class="logo" src="https://ik.imagekit.io/wbhsmslogo/Nav_LogoClosed.png?updatedAt=1751197276128"
        alt="CHO Koronadal Logo" />
    </div>
  </header>
  <section class="homepage">
    <div class="registration-box">
      <h2>Change Password</h2>
      <form id="changePwForm" class="form" autocomplete="off" novalidate>
        <div class="password-wrapper">
          <label for="password">New Password*</label>
          <input type="password" id="password" name="password" class="input-field" required autocomplete="new-password"
            aria-describedby="pw-req" />
          <i class="fa-solid fa-eye toggle-password" aria-hidden="true"></i>
        </div>
        <div class="password-wrapper">
          <label for="confirm-password">Confirm New Password*</label>
          <input type="password" id="confirm-password" name="confirm_password" class="input-field" required
            autocomplete="new-password" />
          <i class="fa-solid fa-eye toggle-password" aria-hidden="true"></i>
        </div>
        <ul class="password-requirements" id="password-requirements">
          <h4 id="pw-req">Password Requirements:</h4>
          <li id="length"><i class="fa-solid fa-circle-xmark icon red"></i> At least 8 characters</li>
          <li id="uppercase"><i class="fa-solid fa-circle-xmark icon red"></i> At least one uppercase letter</li>
          <li id="lowercase"><i class="fa-solid fa-circle-xmark icon red"></i> At least one lowercase letter</li>
          <li id="number"><i class="fa-solid fa-circle-xmark icon red"></i> At least one number</li>
          <li id="match"><i class="fa-solid fa-circle-xmark icon red"></i> Passwords match</li>
        </ul>
        <div id="error" class="error" role="alert" aria-live="polite" style="display:none"></div>
        <div class="form-footer">
          <button id="submitBtn" type="submit" class="btn">Change Password <i
              class="fa-solid fa-arrow-right"></i></button>
        </div>
      </form>
    </div>
  </section>
  <script>
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const pw = $('#password');
    const confirmPw = $('#confirm-password');
    const reqs = {
      length: v => v.length >= 8,
      uppercase: v => /[A-Z]/.test(v),
      lowercase: v => /[a-z]/.test(v),
      number: v => /[0-9]/.test(v)
    };
    const updateReq = (li, ok) => {
      const icon = li.querySelector('i');
      if (ok) {
        icon.classList.remove('fa-circle-xmark', 'red');
        icon.classList.add('fa-circle-check', 'green');
      } else {
        icon.classList.remove('fa-circle-check', 'green');
        icon.classList.add('fa-circle-xmark', 'red');
      }
    };
    function updateAllPwReqs() {
      const v = pw.value;
      updateReq($('#length'), reqs.length(v));
      updateReq($('#uppercase'), reqs.uppercase(v));
      updateReq($('#lowercase'), reqs.lowercase(v));
      updateReq($('#number'), reqs.number(v));
      updateReq($('#match'), v && v === confirmPw.value && confirmPw.value.length > 0);
    }
    pw.addEventListener('input', updateAllPwReqs);
    confirmPw.addEventListener('input', updateAllPwReqs);
    document.addEventListener('click', (e) => {
      const icon = e.target.closest('.toggle-password');
      if (!icon) return;
      const input = icon.previousElementSibling;
      if (!input) return;
      const newType = input.type === 'password' ? 'text' : 'password';
      input.type = newType;
      icon.classList.toggle('fa-eye');
      icon.classList.toggle('fa-eye-slash');
    });
    const form = document.getElementById('changePwForm');
    const error = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');
    function showError(msg) {
      error.textContent = msg;
      error.style.display = 'block';
      setTimeout(() => { error.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 50);
    }
    function clearError() {
      error.textContent = '';
      error.style.display = 'none';
    }
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      clearError();
      const p1 = pw.value;
      const p2 = confirmPw.value;
      if (!reqs.length(p1) || !reqs.uppercase(p1) || !reqs.lowercase(p1) || !reqs.number(p1)) {
        showError('Password must be at least 8 chars with uppercase, lowercase, and a number.');
        return;
      }
      if (p1 !== p2) {
        showError('Passwords do not match.');
        return;
      }
      submitBtn.disabled = true;
      fetch('changePassword.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'password=' + encodeURIComponent(p1)
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            window.location.href = 'changePasswordSuccess.html';
          } else {
            showError(data.message || 'Could not change password.');
            submitBtn.disabled = false;
          }
        })
        .catch(() => {
          showError('Server error. Please try again.');
          submitBtn.disabled = false;
        });
    });
  </script>
</body>

</html>